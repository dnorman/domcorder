<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Hello</p>
    <script type="module">
      import {StyleSheetWatcher} from "../dist/index.js";
      const watcher = new StyleSheetWatcher({
        patchCSSOM: true,
        handler: (event) => {
          console.log(event);
        }
      });
      
      watcher.start();

      const style1 = document.createElement("style");
      style1.innerText = "p { background-color: yellow }";

      const style2 = document.createElement("style");
      style2.innerText = "p { background-color: blue }";

      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "style.css";

      const constructedStyle = new CSSStyleSheet();
      constructedStyle.replaceSync("p { text-decoration: underline }");

      async function runTask(task, delay) {
        return new Promise(resolve => {
          setTimeout(() => {
            task();
            resolve();
          }, delay);
        });
      }

      async function runTasks() {
        const interval = 500;
        await runTask(() => document.body.appendChild(style1), interval);
        await runTask(() => document.body.appendChild(style2), interval);
        await runTask(() => document.body.removeChild(style2), interval);
        await runTask(() => document.body.appendChild(link), interval);
        await runTask(() => document.body.removeChild(link), interval);
        await runTask(() => {
          // Will likely cause a childList mutation event on the style element
          style1.innerText = "p { background-color: green }";
        }, interval);
        await runTask(() => {
          // Will likely cause a characterData mutation event on the style element
          style1.childNodes[0].textContent = "p { background-color: lightgreen }";
        }, interval);

        await runTask(() => {
          document.adoptedStyleSheets = [...document.adoptedStyleSheets, constructedStyle];
        }, interval);
        await runTask(() => {
          constructedStyle.insertRule("p { background-color: white }", 0);
        }, interval);
        await runTask(() => {
          constructedStyle.deleteRule(1);
        }, interval);
        await runTask(() => {
          constructedStyle.replaceSync("p { text-decoration: overline }");
        }, interval);
        await runTask(() => {
          document.adoptedStyleSheets = document.adoptedStyleSheets.filter(sheet => sheet !== constructedStyle);
        }, interval);
      }

      runTasks();
    </script>
  </body>
</html>